name: Issue Management

on:
  issues:
    types: [opened]

jobs:
  manage-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # needed to create branches
      issues: write         # needed to assign and label issues

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # â”€â”€ 1. Create a branch for the issue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create branch for issue
        id: create_branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_ID: ${{ github.event.issue.number }}
        run: |
          BRANCH_NAME="workflow/issue-${ISSUE_ID}"
          echo "branch_name=${BRANCH_NAME}" >> "$GITHUB_OUTPUT"

          # Check whether the branch already exists on the remote
          if git ls-remote --exit-code --heads origin "${BRANCH_NAME}" > /dev/null 2>&1; then
            echo "Branch ${BRANCH_NAME} already exists â€“ skipping creation."
          else
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git checkout -b "${BRANCH_NAME}"
            git push origin "${BRANCH_NAME}"
            echo "Branch ${BRANCH_NAME} created successfully."
          fi

      # â”€â”€ 2. Assign the issue to the user who opened it â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Assign issue to creator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          CREATOR: ${{ github.event.issue.user.login }}
          REPO: ${{ github.repository }}
        run: |
          gh issue edit "${ISSUE_NUMBER}" \
            --repo "${REPO}" \
            --add-assignee "${CREATOR}"

      # â”€â”€ 3. Add GitHub Copilot as an additional assignee â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Requires: Copilot is enabled on the repository/organisation.
      # Uses GITHUB_TOKEN â€“ no extra PAT needed.
      - name: Add Copilot as assignee
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          BRANCH_NAME: ${{ steps.create_branch.outputs.branch_name }}
        run: |
          # PATCH the issue to add "copilot" to the assignees list.
          # GitHub resolves "copilot" to the Copilot coding agent when the
          # feature is enabled on the repo/org.
          gh api --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${REPO}/issues/${ISSUE_NUMBER} \
            -f "assignees[]=copilot"
          echo "Copilot agent assigned to issue #${ISSUE_NUMBER}."

      # â”€â”€ 4. Create labels (if absent) and apply them to the issue â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Ensure required labels exist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH_NAME: ${{ steps.create_branch.outputs.branch_name }}
          CREATOR: ${{ github.event.issue.user.login }}
        run: |
          create_label_if_missing() {
            local label="$1"
            local color="$2"
            local description="$3"
            if ! gh label list --repo "${REPO}" --json name -q '.[].name' | grep -qxF "${label}"; then
              gh label create "${label}" \
                --repo "${REPO}" \
                --color "${color}" \
                --description "${description}"
            fi
          }

          create_label_if_missing "branch:${BRANCH_NAME}"   "0075ca" "Linked branch for this issue"
          create_label_if_missing "assignee:${CREATOR}"     "e4e669" "Issue created by ${CREATOR}"
          create_label_if_missing "assignee:copilot"        "d93f0b" "Assigned to GitHub Copilot agent"

      - name: Label issue with branch and assignee info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          BRANCH_NAME: ${{ steps.create_branch.outputs.branch_name }}
          CREATOR: ${{ github.event.issue.user.login }}
        run: |
          gh issue edit "${ISSUE_NUMBER}" \
            --repo "${REPO}" \
            --add-label "branch:${BRANCH_NAME},assignee:${CREATOR},assignee:copilot"

      # â”€â”€ 5. Post a summary comment on the issue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Post summary comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          BRANCH_NAME: ${{ steps.create_branch.outputs.branch_name }}
          CREATOR: ${{ github.event.issue.user.login }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --repo "${REPO}" \
            --body "$(cat <<EOF
          ### ðŸ¤– Issue automation summary

          | Item | Value |
          |------|-------|
          | **Branch created** | \`${BRANCH_NAME}\` |
          | **Assigned to (creator)** | @${CREATOR} |
          | **Assigned to (Copilot)** | @copilot-swe-agent[bot] |
          | **Labels applied** | \`branch:${BRANCH_NAME}\` Â· \`assignee:${CREATOR}\` Â· \`assignee:copilot\` |
          EOF
          )"

