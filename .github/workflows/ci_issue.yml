name: Auto-assign Issues to GitHub Copilot

on:
  issues:
    types: [ opened ]

jobs:
  assign-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create branch for issue
        id: create-branch
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const branchName = `copilot/issue-${issueNumber}`;
            
            // Get the default branch SHA
            const { data: ref } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });
            
            // Create new branch from main
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: ref.object.sha
              });
              console.log(`‚úÖ Created branch: ${branchName}`);
            } catch (error) {
              if (error.status === 422) {
                console.log(`‚ö†Ô∏è Branch ${branchName} already exists`);
              } else {
                throw error;
              }
            }
            
            // Set output for next steps
            core.setOutput('branch_name', branchName);
            core.setOutput('issue_number', issueNumber);
            
            return branchName;

      - name: Comment on issue with branch details
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.create-branch.outputs.branch_name }}';
            const issueNumber = ${{ steps.create-branch.outputs.issue_number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ü§ñ **Branch Created Successfully!**\n\n` +
                    `- **Branch Name:** \`${branchName}\`\n` +
                    `- **Base Branch:** \`main\`\n\n` +
                    `GitHub Copilot will work on this branch to resolve the issue.`
            });

      - name: Assign issue to GitHub Copilot
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create-branch.outputs.issue_number }};
            
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              assignees: ['copilot-swe-agent[bot]']
            });

      - name: Add labels to issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create-branch.outputs.issue_number }};
            const branchName = '${{ steps.create-branch.outputs.branch_name }}';
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['copilot-workspace', branchName]
            });
